<div class="patient-page">
  <div class="patient-container">
    <section class="patient-hero">
      <div>
        <p class="eyebrow">Tu espacio como paciente</p>
        <h1>Encuentra tu especialista y reserva tu cita</h1>
        <p class="muted">Revisa tu historial, controla tus citas y mantén tus datos médicos al día.</p>
        <div class="hero-actions">
          <%= link_to "Reservar cita", new_patients_appointment_path, class: "btn-lilac" %>
          <%= link_to "Ver doctores", patients_doctors_path, class: "btn-ghost" %>
          <%= link_to "Asistente IA", patients_assistant_path, class: "btn-ghost" %>
        </div>
      </div>
      <div class="hero-card">
        <p class="eyebrow">Tus datos</p>
        <h3><%= @patient.user.name %> <%= @patient.user.last_name %></h3>
        <p class="muted">Tipo de sangre: <strong><%= @patient.blood_type %></strong></p>
        <p class="muted">Contacto de emergencia: <strong><%= @patient.emergency_contact %></strong></p>
      </div>
    </section>

    <section class="patient-panels">
      <div class="panel panel-wide">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Próximas citas</p>
            <h2>Tus citas agendadas</h2>
          </div>
          <%= link_to "Ver todas", patients_appointments_path, class: "link-lilac" %>
        </div>
        <% if @upcoming_appointments.any? %>
          <div class="timeline-list">
            <% @upcoming_appointments.first(3).each do |appointment| %>
              <article class="timeline-card">
                <div class="timeline-date">
                  <span class="day"><%= appointment.date&.strftime('%d') %></span>
                  <span class="month"><%= appointment.date&.strftime('%b') %></span>
                  <span class="time"><%= appointment.hour&.strftime('%H:%M') %></span>
                </div>
                <div class="timeline-body">
                  <p class="timeline-title">
                    <%= link_to "#{appointment.doctor.user.name} #{appointment.doctor.user.last_name}",
                                patients_doctor_path(appointment.doctor),
                                class: "doctor-link" %>
                  </p>
                  <p class="muted small"><%= appointment.doctor.speciality.humanize %></p>
                  <div class="timeline-actions">
                    <span class="status-pill <%= appointment.status %>"><%= appointment.status %></span>
                    <%= link_to "Ver", patients_appointment_path(appointment), class: "btn-ghost-sm" %>
                  </div>
                </div>
              </article>
            <% end %>
          </div>
        <% else %>
          <p class="muted">Aún no tienes citas programadas.</p>
        <% end %>
      </div>

      <div class="panel-grid">
        <div class="panel">
          <div class="panel-header">
            <div>
              <p class="eyebrow">Tu salud</p>
              <h2>Historial médico reciente</h2>
            </div>
            <%= link_to "Ver historial", patients_medical_histories_path, class: "link-lilac" %>
          </div>
          <% if @recent_medical_histories.any? %>
            <div class="stacked-cards">
              <% @recent_medical_histories.each do |history| %>
                <article class="stacked-card">
                  <div class="card-icon">
                    <i class="fa fa-file-medical-alt"></i>
                  </div>
                  <div class="stacked-body">
                    <p class="stacked-title"><%= history.diagnosis.truncate(40) %></p>
                    <p class="muted small"><%= history.registration_date&.strftime('%d %b %Y') %> · <%= history.doctor.user.name %></p>
                  </div>
                  <%= link_to "Ver detalle", patients_medical_history_path(history), class: "link-lilac stacked-link" %>
                </article>
              <% end %>
            </div>
          <% else %>
            <p class="muted">Aún no hay registros médicos.</p>
          <% end %>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div>
              <p class="eyebrow">Archivos subidos</p>
              <h2>Exámenes recientes</h2>
            </div>
            <%= link_to "Abrir asistente", patients_assistant_path, class: "link-lilac" %>
          </div>
          <% if @recent_exam_uploads.any? %>
            <div class="stacked-cards">
              <% @recent_exam_uploads.each do |message| %>
                <article class="stacked-card">
                  <div class="card-icon neutral">
                    <i class="fa fa-file-medical"></i>
                  </div>
                  <div class="stacked-body">
                    <p class="stacked-title"><%= message.created_at.strftime("%d %b %Y") %></p>
                    <p class="muted small"><%= truncate(message.content, length: 80) %></p>
                    <% if message.documents.attached? %>
                      <ul class="ai-attachments small">
                        <% message.documents.each do |doc| %>
                          <li><%= link_to doc.filename.to_s, url_for(doc), target: "_blank", rel: "noopener" %></li>
                        <% end %>
                      </ul>
                    <% end %>
                  </div>
                </article>
              <% end %>
            </div>
          <% else %>
            <p class="muted">Todavía no has guardado exámenes en tu historial.</p>
          <% end %>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="admin-page-header">
  <div>
    <span class="page-eyebrow">Coordinacion</span>
    <h1 class="admin-page-title">Citas programadas</h1>
    <p class="admin-page-description">
      Visualiza la agenda completa para conectar pacientes y doctores de forma impecable.
    </p>
  </div>
  <div class="admin-actions">
    <%= link_to "Nueva cita", new_admin_appointment_path, class: "btn-leva-primary" %>
    <%= link_to "Ver dashboard", admin_dashboard_path, class: "btn-leva-ghost" %>
  </div>
</div>

<% filters_active = @filter_params.to_h.values.any?(&:present?) %>
<div class="admin-card admin-filter-card">
  <%= form_with url: admin_appointments_path, method: :get, local: true, html: { class: "admin-filter-form" } do %>
    <div class="admin-filter-grid">
      <div class="admin-filter-group">
        <%= label_tag :patient_query, "Paciente" %>
        <%= text_field_tag :patient_query,
                           @filter_params[:patient_query],
                           placeholder: "Nombre o correo",
                           class: "admin-filter-input" %>
      </div>
      <div class="admin-filter-group">
        <%= label_tag :doctor_query, "Doctor" %>
        <%= text_field_tag :doctor_query,
                           @filter_params[:doctor_query],
                           placeholder: "Nombre o especialidad",
                           class: "admin-filter-input" %>
      </div>
      <div class="admin-filter-group">
        <%= label_tag :date_from, "Desde" %>
        <%= date_field_tag :date_from,
                           @filter_params[:date_from],
                           class: "admin-filter-input" %>
      </div>
      <div class="admin-filter-group">
        <%= label_tag :date_to, "Hasta" %>
        <%= date_field_tag :date_to,
                           @filter_params[:date_to],
                           class: "admin-filter-input" %>
      </div>
      <div class="admin-filter-group">
        <%= label_tag :hour, "Hora" %>
        <%= time_field_tag :hour,
                           @filter_params[:hour],
                           class: "admin-filter-input",
                           placeholder: "HH:MM" %>
      </div>
    </div>
    <div class="admin-filter-actions">
      <%= submit_tag "Aplicar filtros", class: "btn-leva-primary" %>
      <% if filters_active %>
        <%= link_to "Limpiar filtros", admin_appointments_path, class: "btn-leva-ghost" %>
      <% end %>
    </div>
  <% end %>
</div>

<div class="admin-card">
  <table class="admin-table">
    <thead>
      <tr>
        <th>Paciente</th>
        <th>Doctor</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
      <% @appointments.each do |appointment| %>
        <% patient_user = appointment.patient&.user %>
        <% doctor_user = appointment.doctor&.user %>
        <% status_chip_class = case appointment.status
                              when "confirmed", "completed" then "status-chip--success"
                              when "cancelled" then "status-chip--danger"
                              else "" end %>
        <tr>
          <td>
            <strong><%= patient_user&.name %> <%= patient_user&.last_name %></strong><br>
            <small class="admin-row-meta"><%= patient_user&.email %></small>
          </td>
          <td>
            <strong><%= doctor_user&.name %> <%= doctor_user&.last_name %></strong><br>
            <small class="admin-row-meta"><%= appointment.doctor&.speciality&.humanize || "Sin especialidad" %></small>
          </td>
          <td><%= l(appointment.date) if appointment.date %></td>
          <td><%= appointment.hour&.strftime("%I:%M %p") || "--" %></td>
          <td>
            <span class="status-chip <%= status_chip_class %>"><%= appointment.status.humanize %></span>
          </td>
          <td>
            <div class="admin-actions admin-actions--stack">
              <%= link_to "Ver", admin_appointment_path(appointment), class: "btn-soft btn-soft--info" %>
              <%= link_to "Editar", edit_admin_appointment_path(appointment), class: "btn-soft btn-soft--warning" %>
              <%#= link_to "Eliminar",
                          admin_appointment_path(appointment),
                          data: { turbo_method: :delete, turbo_confirm: "¿Seguro que deseas eliminar esta cita?" },
                          class: "btn-soft btn-soft--danger"%>
              <%= button_to "Eliminar", admin_appointment_path(appointment) ,
                            method: :delete, confirm: "¿Seguro que deseas eliminar esta cita?",
                            class: "btn-soft btn-soft--danger" %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

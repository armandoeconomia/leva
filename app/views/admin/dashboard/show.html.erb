<div class="admin-page-header">
  <div>
    <span class="page-eyebrow">Panel principal</span>
    <h1 class="admin-page-title">Resumen operativo</h1>
    <p class="admin-page-description">
      Monitorea actividad diaria y navega rapidamente a usuarios, pacientes o citas para tomar accion.
    </p>
  </div>
  <div class="admin-actions">
    <%= link_to "Nueva cita", new_admin_appointment_path, class: "btn-leva-primary" %>
    <%= link_to "Crear usuario", new_admin_user_path, class: "btn-leva-ghost" %>
    <%= link_to "Asistente IA", admin_assistant_path, class: "btn-leva-ghost" %>
  </div>
</div>

<div class="admin-metrics">
  <div class="admin-metric-card">
    <p class="admin-metric-value"><%= @total_users %></p>
    <p class="admin-metric-label">Usuarios</p>
  </div>
  <div class="admin-metric-card">
    <p class="admin-metric-value"><%= @total_patients %></p>
    <p class="admin-metric-label">Pacientes</p>
  </div>
  <div class="admin-metric-card">
    <p class="admin-metric-value"><%= @total_doctors %></p>
    <p class="admin-metric-label">Doctores</p>
  </div>
  <div class="admin-metric-card">
    <p class="admin-metric-value"><%= @appointments_today %></p>
    <p class="admin-metric-label">Citas hoy</p>
  </div>
</div>

<section class="admin-card admin-sales-card">
  <div class="admin-card__header">
    <div>
      <p class="page-eyebrow">Ventas</p>
      <h2 class="admin-card__title">Ingresos por citas</h2>
      <p class="admin-card__description">
        Visualiza la evolución mensual de ingresos según el costo asociado a cada cita agendada.
      </p>
    </div>
  </div>
  <% if @sales_chart_data.present? %>
    <div class="admin-sales-grid">
      <div class="sales-summary">
        <div class="sales-summary__item">
          <span class="sales-summary__label">Ingresos totales</span>
          <strong class="sales-summary__value"><%= number_to_currency(@sales_summary[:total_revenue], precision: 0) %></strong>
        </div>
        <div class="sales-summary__item">
          <span class="sales-summary__label">Citas facturadas</span>
          <strong class="sales-summary__value"><%= @sales_summary[:total_appointments] %></strong>
        </div>
        <div class="sales-summary__item">
          <span class="sales-summary__label">Ticket promedio</span>
          <strong class="sales-summary__value"><%= number_to_currency(@sales_summary[:average_ticket], precision: 0) %></strong>
        </div>
        <div class="sales-summary__item">
          <span class="sales-summary__label">Mejor mes</span>
          <strong class="sales-summary__value">
            <% if @sales_summary[:best_month_label].present? %>
              <%= @sales_summary[:best_month_label] %>
              ·
              <%= number_to_currency(@sales_summary[:best_month_revenue], precision: 0) %>
            <% else %>
              N/D
            <% end %>
          </strong>
        </div>
      </div>
      <% max_revenue = @sales_chart_data.map { |point| point[:revenue] }.max.to_f %>
      <div class="sales-chart" role="img" aria-label="Gráfico de ingresos mensuales por citas">
        <% @sales_chart_data.each do |point| %>
          <% height = max_revenue.zero? ? 0 : ((point[:revenue] / max_revenue) * 100).round %>
          <div class="sales-chart__column">
            <div class="sales-chart__bar" style="height: <%= height %>%;">
              <span class="sales-chart__bar-value"><%= number_to_currency(point[:revenue], precision: 0) %></span>
            </div>
            <p class="sales-chart__label"><%= point[:label] %></p>
            <span class="sales-chart__appointments"><%= point[:appointments] %> citas</span>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <p class="muted mb-0">Aún no hay información de citas para graficar ventas.</p>
  <% end %>
</section>

<section class="admin-card mt-8">
  <div class="admin-card__header">
    <div>
      <p class="page-eyebrow">Seguimiento</p>
      <h2 class="admin-card__title">Próximas citas</h2>
      <p class="admin-card__description">
        Visualiza las próximas reservas creadas por pacientes o administradores y toma acción inmediata.
      </p>
    </div>
    <%= link_to "Ver todas", admin_appointments_path, class: "btn-leva-ghost" %>
  </div>
  <% if @upcoming_appointments.any? %>
    <div class="admin-table-wrapper">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Paciente</th>
            <th>Doctor</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% @upcoming_appointments.each do |appointment| %>
            <tr>
              <td><%= appointment.date&.strftime('%d %b %Y') %></td>
              <td><%= appointment.hour&.strftime('%H:%M') %></td>
              <td>
                <strong><%= appointment.patient.user.name %> <%= appointment.patient.user.last_name %></strong>
              </td>
              <td><%= appointment.doctor.user.name %> <%= appointment.doctor.user.last_name %></td>
              <td><span class="status-pill <%= appointment.status %>"><%= appointment.status.titleize %></span></td>
              <td class="text-right">
                <%= link_to "Abrir", admin_appointment_path(appointment), class: "btn-leva-link" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="muted">Aún no se registran citas futuras.</p>
  <% end %>
</section>

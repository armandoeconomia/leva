<% appointments = @appointments || [] %>
<% pending = appointments.select { |a| a.status == "pendiente" } %>

<div class="admin-shell" style="padding: 32px 40px 48px;">
  <div class="admin-page-header">
    <div>
      <span class="page-eyebrow">Citas</span>
      <h1 class="admin-page-title">Citas asignadas</h1>
      <p class="admin-page-description">
        Gestiona tus citas: revisa, edita, confirma o cancela con la misma estética del panel.
      </p>
    </div>
    <div class="admin-actions">
      <%= link_to "Actualizar", doctors_appointments_path, class: "btn-leva-ghost" %>
    </div>
  </div>

  <div class="admin-metrics" style="gap: 18px; flex-wrap: wrap;">
    <div class="admin-metric-card" style="border-radius: 24px; box-shadow: 0 18px 32px rgba(0,0,0,0.06);">
      <p class="admin-metric-value"><%= appointments.size %></p>
      <p class="admin-metric-label">Total citas</p>
    </div>
    <div class="admin-metric-card" style="border-radius: 24px; box-shadow: 0 18px 32px rgba(0,0,0,0.06);">
      <p class="admin-metric-value"><%= pending.size %></p>
      <p class="admin-metric-label">Pendientes</p>
    </div>
    <div class="admin-metric-card" style="border-radius: 24px; box-shadow: 0 18px 32px rgba(0,0,0,0.06);">
      <p class="admin-metric-value"><%= appointments.count { |a| a.status == "completado" } %></p>
      <p class="admin-metric-label">Completadas</p>
    </div>
    <div class="admin-metric-card" style="border-radius: 24px; box-shadow: 0 18px 32px rgba(0,0,0,0.06);">
      <p class="admin-metric-value"><%= appointments.count { |a| a.status == "cancelado" } %></p>
      <p class="admin-metric-label">Canceladas</p>
    </div>
  </div>

<section class="admin-card mt-8" style="border-radius: 24px; box-shadow: 0 24px 44px rgba(0,0,0,0.06); padding: 24px;">
  <div class="admin-card__header">
    <div>
      <p class="page-eyebrow">Listado</p>
      <h2 class="admin-card__title">Citas agendadas</h2>
      <p class="admin-card__description">
        Visualiza tus citas con estado y acciones rápidas.
      </p>
    </div>
  </div>

  <% if appointments.any? %>
    <div class="admin-table-wrapper" style="border-radius: 18px; overflow: hidden;">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Paciente</th>
            <th>Motivo</th>
            <th>Estado</th>
            <th class="text-right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% appointments.each do |appt| %>
            <% patient_name = appt.patient&.user&.name || "Paciente" %>
            <tr>
              <td><%= l(appt.date, format: '%d %b %Y') rescue appt.date %></td>
              <td><%= appt.hour&.strftime('%H:%M') || appt.hour %></td>
              <td><strong><%= patient_name %></strong></td>
              <td class="text-muted"><%= appt.reason_for_consultation.presence || "Sin motivo" %></td>
              <td><span class="status-pill <%= appt.status %>"><%= appt.status.to_s.titleize %></span></td>
              <td class="text-right">
                <div class="d-flex gap-2 justify-content-end flex-wrap">
                  <%= link_to "Ver", doctors_appointment_path(appt), class: "btn-leva-link" %>
                  <%= link_to "Editar", edit_doctors_appointment_path(appt), class: "btn btn-primary btn-sm" %>
                  <%= link_to "Confirmar", confirm_doctors_appointment_path(appt), method: :patch, class: "btn btn-success btn-sm" %>
                  <%= link_to "Cancelar", cancel_doctors_appointment_path(appt), method: :patch, class: "btn btn-warning btn-sm" %>
                  <%= link_to "Eliminar", doctors_appointment_path(appt), method: :delete, data: { confirm: "¿Eliminar esta cita?" }, class: "btn btn-danger btn-sm" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="muted">No hay citas asignadas todavía.</p>
  <% end %>
</section>
</div>
